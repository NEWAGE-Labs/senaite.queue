<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="senaite.queue">
  <head>
    <metal:block fill-slot="javascript_head_slot"
                 tal:define="portal context/@@plone_portal_state/portal;">
    </metal:block>
    <metal:block fill-slot="style_slot"
                 tal:define="portal context/@@plone_portal_state/portal;">
      <style>
        .task_referer {
          font-size:0.9em;
          color: #666;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
          width: 800px;
        }
        .task_uid {
          font-family: monospace;
          font-size:0.9em;
          width: 7ch;
          overflow: hidden;
          white-space: nowrap;
        }
        .err_msg {
          font-family: monospace;
          font-size:0.9em;
        }
        tr.processed, tr.processed a {
          color: #999;
        }
        tr.running, tr.running a {
          color: #666;
        }
        tr.failed, tr.failed a {
          color: #a73232;
        }
        tr.failed a.btn {
          color: #fff;
        }
      </style>
    </metal:block>
  </head>
  <body tal:define="portal_url nocall:context/portal_url">

    <!-- Title -->
    <metal:title fill-slot="content-title">
      <h1 i18n:translate="">
        Queued tasks
      </h1>
    </metal:title>

    <!-- Content -->
    <metal:core fill-slot="content-core">
      <table class="table table-bordered" tal:define="tasks view/get_tasks">
        <thead>
          <tr>
            <th i18n:translate="">TUID</th>
            <th i18n:translate="">Created</th>
            <th i18n:translate="">User</th>
            <th i18n:translate="">Remote Addr</th>
            <th i18n:translate="">Started</th>
            <th i18n:translate="">Context</th>
            <th i18n:translate="">Type</th>
            <th i18n:translate="">Status</th>
            <th i18n:translate="">Error message</th>
            <th i18n:translate="">Retries</th>
            <th/>
          </tr>
        </thead>
        <tbody>
          <tal:row repeat="task tasks">
            <tr tal:attributes="class task/status">
              <td>
                <div class="task_uid" >
                  <a tal:attributes="href python: view.get_task_json(task)" tal:content="task/task_uid"/>
                </div>
              </td>
              <td tal:content="task/created_date|None"/>
              <td tal:content="task/request/AUTHENTICATED_USER|None"/>
              <td tal:content="task/request/REMOTE_ADDR"/>
              <td tal:content="task/started_date|None"/>
              <td tal:define="context_path task/context_path">
                <a tal:attributes="href python: '{}{}'.format(portal_url, context_path)"
                   tal:content="context_path"/>
              </td>
              <td tal:content="task/name"/>
              <td tal:content="task/status"/>
              <td class="err_msg" tal:content="task/error_message|None"/>
              <td tal:content="task/retries"/>
              <td>
                <a class="btn btn-danger btn-sm"
                   i18n:translate=""
                   tal:condition="python: task['status'] in ['queued', 'failed']"
                   tal:attributes="href python: 'queue_tasks?remove={}'.format(task['task_uid'])">Remove</a>
                <a class="btn btn-default btn-primary btn-sm"
                   i18n:translate=""
                   tal:condition="python: task['status'] in ['queued', 'failed']"
                   tal:attributes="href python: 'queue_tasks?requeue={}'.format(task['task_uid'])">Requeue</a>
              </td>
            </tr>
          </tal:row>
        </tbody>
        <tfoot>
          <tr>
            <th scope="row">Total</th>
            <td tal:define="failed_tasks python:len(filter(lambda t: t['status']=='failed', tasks));
                            running_tasks python:len(filter(lambda t: t['status']=='running', tasks));
                            queued_tasks python:len(filter(lambda t: t['status']=='queued', tasks))"
                tal:content="python: '{} failed, {} running, {} queued'.format(failed_tasks, running_tasks, queued_tasks)"
                colspan="9"/>
          </tr>
        </tfoot>
      </table>

      <div>
        <form class="form"
              id="queue_tasks_form"
              name="queue_tasks_form"
              method="POST">

          <!-- Hidden Fields -->
          <input type="hidden" name="submitted" value="1"/>
          <input tal:replace="structure context/@@authenticator/authenticator"/>

          <!-- Requeue all failed -->
          <input class="btn btn-default btn-primary btn-sm"
                type="submit"
                id="button_requeue_failed"
                name="button_requeue_failed"
                i18n:attributes="value"
                value="Requeue failed tasks"/>

          <!-- Remove all failed -->
          <input class="btn btn-secondary btn-sm"
                 type="submit"
                 id="button_remove_failed"
                 name="button_remove_failed"
                 i18n:attributes="value"
                 value="Remove failed tasks"/>

          <!-- Remove all except running -->
          <input class="btn btn-danger btn-sm"
                 type="submit"
                 id="button_remove_all"
                 name="button_remove_all"
                 i18n:attributes="value"
                 value="Remove all tasks" />

        </form>
      </div>
    </metal:core>
  </body>
</html>